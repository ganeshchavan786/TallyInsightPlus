<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tally Vouchers - TallyBridge</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/tally-common.css">
    <style>
        .voucher-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        .voucher-table th, .voucher-table td { padding: 0.75rem; text-align: left; border-bottom: 1px solid #e2e8f0; }
        .voucher-table th { background: #f8fafc; font-weight: 600; }
        .voucher-table tr:hover { background: #f1f5f9; }
        .filters { display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap; }
        .filters select, .filters input { padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem; }
        .amount { text-align: right !important; font-family: monospace; }
        .voucher-type { display: inline-block; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 500; }
        .voucher-type.sales { background: #dcfce7; color: #166534; }
        .voucher-type.purchase { background: #fef3c7; color: #92400e; }
        .voucher-type.receipt { background: #dbeafe; color: #1e40af; }
        .voucher-type.payment { background: #fee2e2; color: #991b1b; }
        .voucher-type.journal { background: #f3e8ff; color: #6b21a8; }
        .pagination { display: flex; gap: 0.5rem; justify-content: center; margin-top: 1rem; }
        .pagination button { padding: 0.5rem 1rem; border: 1px solid #e2e8f0; background: white; cursor: pointer; border-radius: 0.375rem; }
        .pagination button:hover { background: #f1f5f9; }
        .pagination button:disabled { opacity: 0.5; cursor: not-allowed; }
        .loading { text-align: center; padding: 2rem; color: #64748b; }
        .error { background: #fef2f2; color: #dc2626; padding: 1rem; border-radius: 0.5rem; margin: 1rem 0; }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>TallyBridge</h2>
            </div>
            <ul class="nav-menu">
                <li><a href="dashboard.html"><span class="icon">üìä</span> Dashboard</a></li>
                <li><a href="companies.html"><span class="icon">üè¢</span> Companies</a></li>
                <li><a href="users.html"><span class="icon">üë•</span> Users</a></li>
                <li class="nav-divider">Tally Integration</li>
                <li><a href="tally-sync.html"><span class="icon">üîÑ</span> Sync</a></li>
                <li><a href="tally-ledgers.html"><span class="icon">üìí</span> Ledgers</a></li>
                <li><a href="tally-vouchers.html" class="active"><span class="icon">üìÑ</span> Vouchers</a></li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <header class="content-header">
                <h1>Tally Vouchers</h1>
                <div class="header-actions">
                    <button onclick="loadVouchers()" class="btn btn-primary">üîÑ Refresh</button>
                </div>
            </header>

            <div class="content-body">
                <!-- Filters -->
                <div class="filters">
                    <select id="companyFilter" onchange="loadVouchers()">
                        <option value="">All Companies</option>
                    </select>
                    <select id="typeFilter" onchange="loadVouchers()">
                        <option value="">All Types</option>
                        <option value="Sales">Sales</option>
                        <option value="Purchase">Purchase</option>
                        <option value="Receipt">Receipt</option>
                        <option value="Payment">Payment</option>
                        <option value="Journal">Journal</option>
                        <option value="Contra">Contra</option>
                        <option value="Credit Note">Credit Note</option>
                        <option value="Debit Note">Debit Note</option>
                    </select>
                    <input type="date" id="fromDate" onchange="loadVouchers()">
                    <input type="date" id="toDate" onchange="loadVouchers()">
                </div>

                <!-- Loading -->
                <div id="loading" class="loading" style="display: none;">Loading vouchers...</div>
                
                <!-- Error -->
                <div id="error" class="error" style="display: none;"></div>

                <!-- Vouchers Table -->
                <table class="voucher-table" id="vouchersTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Voucher No</th>
                            <th>Type</th>
                            <th>Party</th>
                            <th class="amount">Amount</th>
                        </tr>
                    </thead>
                    <tbody id="vouchersBody">
                        <!-- Data will be loaded here -->
                    </tbody>
                </table>

                <!-- Pagination -->
                <div class="pagination">
                    <button id="prevBtn" onclick="prevPage()" disabled>‚Üê Previous</button>
                    <span id="pageInfo">Page 1</span>
                    <button id="nextBtn" onclick="nextPage()">Next ‚Üí</button>
                </div>
            </div>
        </main>
    </div>

    <script src="js/api.js"></script>
    <script>
        let currentPage = 0;
        const pageSize = 50;

        async function loadCompanies() {
            try {
                const result = await API.tally.getSyncedCompanies();
                if (result.success && result.data) {
                    const select = document.getElementById('companyFilter');
                    const companies = result.data.companies || result.data || [];
                    companies.forEach(c => {
                        const opt = document.createElement('option');
                        opt.value = c.company_name || c.name || c;
                        opt.textContent = c.company_name || c.name || c;
                        select.appendChild(opt);
                    });
                }
            } catch (e) {
                console.error('Failed to load companies:', e);
            }
        }

        async function loadVouchers() {
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const tbody = document.getElementById('vouchersBody');
            
            loading.style.display = 'block';
            error.style.display = 'none';
            tbody.innerHTML = '';

            try {
                const params = {
                    limit: pageSize,
                    offset: currentPage * pageSize
                };
                
                const company = document.getElementById('companyFilter').value;
                const type = document.getElementById('typeFilter').value;
                const fromDate = document.getElementById('fromDate').value;
                const toDate = document.getElementById('toDate').value;
                
                if (company) params.company = company;
                if (type) params.voucher_type = type;
                if (fromDate) params.from_date = fromDate;
                if (toDate) params.to_date = toDate;

                const result = await API.tally.getVouchers(params);
                
                if (result.success && result.data) {
                    const vouchers = result.data.vouchers || result.data || [];
                    
                    if (vouchers.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#64748b;">No vouchers found</td></tr>';
                    } else {
                        vouchers.forEach(v => {
                            const amount = parseFloat(v.amount || v.total || 0);
                            const typeClass = getTypeClass(v.voucher_type || v.type);
                            
                            tbody.innerHTML += `
                                <tr>
                                    <td>${formatDate(v.date || v.voucher_date)}</td>
                                    <td>${v.voucher_number || v.number || '-'}</td>
                                    <td><span class="voucher-type ${typeClass}">${v.voucher_type || v.type}</span></td>
                                    <td>${v.party_name || v.party || '-'}</td>
                                    <td class="amount">${formatAmount(amount)}</td>
                                </tr>
                            `;
                        });
                    }
                    
                    updatePagination(vouchers.length);
                } else {
                    throw new Error(result.error || 'Failed to load vouchers');
                }
            } catch (e) {
                error.textContent = e.message || 'Failed to load vouchers';
                error.style.display = 'block';
            } finally {
                loading.style.display = 'none';
            }
        }

        function getTypeClass(type) {
            if (!type) return '';
            const t = type.toLowerCase();
            if (t.includes('sales')) return 'sales';
            if (t.includes('purchase')) return 'purchase';
            if (t.includes('receipt')) return 'receipt';
            if (t.includes('payment')) return 'payment';
            if (t.includes('journal')) return 'journal';
            return '';
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const d = new Date(dateStr);
            return d.toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });
        }

        function formatAmount(amount) {
            return new Intl.NumberFormat('en-IN', { 
                style: 'currency', 
                currency: 'INR',
                minimumFractionDigits: 2 
            }).format(Math.abs(amount));
        }

        function updatePagination(count) {
            document.getElementById('pageInfo').textContent = `Page ${currentPage + 1}`;
            document.getElementById('prevBtn').disabled = currentPage === 0;
            document.getElementById('nextBtn').disabled = count < pageSize;
        }

        function prevPage() {
            if (currentPage > 0) {
                currentPage--;
                loadVouchers();
            }
        }

        function nextPage() {
            currentPage++;
            loadVouchers();
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadCompanies();
            loadVouchers();
        });
    </script>
</body>
</html>
