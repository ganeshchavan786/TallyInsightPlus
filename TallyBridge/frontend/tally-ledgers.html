<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tally Ledgers - TallyBridge</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/tally-common.css">
    <style>
        .ledger-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        .ledger-table th, .ledger-table td { padding: 0.75rem; text-align: left; border-bottom: 1px solid #e2e8f0; }
        .ledger-table th { background: #f8fafc; font-weight: 600; }
        .ledger-table tr:hover { background: #f1f5f9; }
        .filters { display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap; }
        .filters select, .filters input { padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.375rem; }
        .amount { text-align: right !important; font-family: monospace; }
        .amount.positive { color: #16a34a; }
        .amount.negative { color: #dc2626; }
        .pagination { display: flex; gap: 0.5rem; justify-content: center; margin-top: 1rem; }
        .pagination button { padding: 0.5rem 1rem; border: 1px solid #e2e8f0; background: white; cursor: pointer; border-radius: 0.375rem; }
        .pagination button:hover { background: #f1f5f9; }
        .pagination button:disabled { opacity: 0.5; cursor: not-allowed; }
        .loading { text-align: center; padding: 2rem; color: #64748b; }
        .error { background: #fef2f2; color: #dc2626; padding: 1rem; border-radius: 0.5rem; margin: 1rem 0; }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>TallyBridge</h2>
            </div>
            <ul class="nav-menu">
                <li><a href="dashboard.html"><span class="icon">üìä</span> Dashboard</a></li>
                <li><a href="companies.html"><span class="icon">üè¢</span> Companies</a></li>
                <li><a href="users.html"><span class="icon">üë•</span> Users</a></li>
                <li class="nav-divider">Tally Integration</li>
                <li><a href="tally-sync.html"><span class="icon">üîÑ</span> Sync</a></li>
                <li><a href="tally-ledgers.html" class="active"><span class="icon">üìí</span> Ledgers</a></li>
                <li><a href="tally-vouchers.html"><span class="icon">üìÑ</span> Vouchers</a></li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <header class="content-header">
                <h1>Tally Ledgers</h1>
                <div class="header-actions">
                    <button onclick="loadLedgers()" class="btn btn-primary">üîÑ Refresh</button>
                </div>
            </header>

            <div class="content-body">
                <!-- Filters -->
                <div class="filters">
                    <select id="companyFilter" onchange="loadLedgers()">
                        <option value="">All Companies</option>
                    </select>
                    <select id="groupFilter" onchange="loadLedgers()">
                        <option value="">All Groups</option>
                    </select>
                    <input type="text" id="searchFilter" placeholder="Search ledger..." onkeyup="debounceSearch()">
                </div>

                <!-- Loading -->
                <div id="loading" class="loading" style="display: none;">Loading ledgers...</div>
                
                <!-- Error -->
                <div id="error" class="error" style="display: none;"></div>

                <!-- Ledgers Table -->
                <table class="ledger-table" id="ledgersTable">
                    <thead>
                        <tr>
                            <th>Ledger Name</th>
                            <th>Group</th>
                            <th class="amount">Opening Balance</th>
                            <th class="amount">Closing Balance</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="ledgersBody">
                        <!-- Data will be loaded here -->
                    </tbody>
                </table>

                <!-- Pagination -->
                <div class="pagination">
                    <button id="prevBtn" onclick="prevPage()" disabled>‚Üê Previous</button>
                    <span id="pageInfo">Page 1</span>
                    <button id="nextBtn" onclick="nextPage()">Next ‚Üí</button>
                </div>
            </div>
        </main>
    </div>

    <script src="js/api.js"></script>
    <script>
        let currentPage = 0;
        const pageSize = 50;
        let searchTimeout = null;

        async function loadCompanies() {
            try {
                const result = await API.tally.getSyncedCompanies();
                if (result.success && result.data) {
                    const select = document.getElementById('companyFilter');
                    const companies = result.data.companies || result.data || [];
                    companies.forEach(c => {
                        const opt = document.createElement('option');
                        opt.value = c.company_name || c.name || c;
                        opt.textContent = c.company_name || c.name || c;
                        select.appendChild(opt);
                    });
                }
            } catch (e) {
                console.error('Failed to load companies:', e);
            }
        }

        async function loadGroups() {
            try {
                const result = await API.tally.getGroups();
                if (result.success && result.data) {
                    const select = document.getElementById('groupFilter');
                    const groups = result.data.groups || result.data || [];
                    groups.forEach(g => {
                        const opt = document.createElement('option');
                        opt.value = g.name || g;
                        opt.textContent = g.name || g;
                        select.appendChild(opt);
                    });
                }
            } catch (e) {
                console.error('Failed to load groups:', e);
            }
        }

        async function loadLedgers() {
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const tbody = document.getElementById('ledgersBody');
            
            loading.style.display = 'block';
            error.style.display = 'none';
            tbody.innerHTML = '';

            try {
                const params = {
                    limit: pageSize,
                    offset: currentPage * pageSize
                };
                
                const company = document.getElementById('companyFilter').value;
                const group = document.getElementById('groupFilter').value;
                const search = document.getElementById('searchFilter').value;
                
                if (company) params.company = company;
                if (group) params.group = group;
                if (search) params.search = search;

                const result = await API.tally.getLedgers(params);
                
                if (result.success && result.data) {
                    const ledgers = result.data.ledgers || result.data || [];
                    
                    if (ledgers.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#64748b;">No ledgers found</td></tr>';
                    } else {
                        ledgers.forEach(l => {
                            const opening = parseFloat(l.opening_balance || 0);
                            const closing = parseFloat(l.closing_balance || l.opening_balance || 0);
                            
                            tbody.innerHTML += `
                                <tr>
                                    <td><a href="tally-ledger-detail.html?name=${encodeURIComponent(l.name)}">${l.name}</a></td>
                                    <td>${l.parent || l.group || '-'}</td>
                                    <td class="amount ${opening >= 0 ? 'positive' : 'negative'}">${formatAmount(opening)}</td>
                                    <td class="amount ${closing >= 0 ? 'positive' : 'negative'}">${formatAmount(closing)}</td>
                                    <td><button onclick="viewLedger('${l.name}')" class="btn btn-sm">View</button></td>
                                </tr>
                            `;
                        });
                    }
                    
                    updatePagination(ledgers.length);
                } else {
                    throw new Error(result.error || 'Failed to load ledgers');
                }
            } catch (e) {
                error.textContent = e.message || 'Failed to load ledgers';
                error.style.display = 'block';
            } finally {
                loading.style.display = 'none';
            }
        }

        function formatAmount(amount) {
            return new Intl.NumberFormat('en-IN', { 
                style: 'currency', 
                currency: 'INR',
                minimumFractionDigits: 2 
            }).format(Math.abs(amount)) + (amount < 0 ? ' Cr' : ' Dr');
        }

        function updatePagination(count) {
            document.getElementById('pageInfo').textContent = `Page ${currentPage + 1}`;
            document.getElementById('prevBtn').disabled = currentPage === 0;
            document.getElementById('nextBtn').disabled = count < pageSize;
        }

        function prevPage() {
            if (currentPage > 0) {
                currentPage--;
                loadLedgers();
            }
        }

        function nextPage() {
            currentPage++;
            loadLedgers();
        }

        function debounceSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                currentPage = 0;
                loadLedgers();
            }, 300);
        }

        function viewLedger(name) {
            window.location.href = `tally-ledger-detail.html?name=${encodeURIComponent(name)}`;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadCompanies();
            loadGroups();
            loadLedgers();
        });
    </script>
</body>
</html>
