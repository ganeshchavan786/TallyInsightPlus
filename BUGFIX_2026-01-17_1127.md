# Bug Fix Task List - Navigation & CSP Issues
**Date:** 2026-01-17 11:27 AM
**Issue:** Multiple issues found during testing

---

## Issues Identified (from Images & Console):

### Issue 1: Dashboard Refresh ‚Üí Sync Page Redirect
- **Problem:** Dashboard refresh ‡§ï‡•á‡§≤‡•ç‡§Ø‡§æ‡§µ‡§∞ ‡§™‡•Å‡§®‡•ç‡§π‡§æ Sync page ‡§µ‡§∞ ‡§ú‡§æ‡§§‡•ã
- **Cause:** `company_count = 0` ‡§Ö‡§∏‡§≤‡•ç‡§Ø‡§æ‡§Æ‡•Å‡§≥‡•á redirect ‡§π‡•ã‡§§‡•ã‡§Ø
- **Root Cause:** Company synced ‡§Ü‡§π‡•á ‡§™‡§£ TallyBridge database ‡§Æ‡§ß‡•ç‡§Ø‡•á link ‡§®‡§æ‡§π‡•Ä

### Issue 2: Tally Sync Link Not Visible in Sidebar
- **Problem:** Sidebar ‡§Æ‡§ß‡•ç‡§Ø‡•á "üîÑ Tally Sync" link ‡§¶‡§ø‡§∏‡§§ ‡§®‡§æ‡§π‡•Ä
- **Image 2:** Sidebar ‡§¶‡§ø‡§∏‡§§‡•ã‡§Ø ‡§™‡§£ Tally Sync link ‡§®‡§æ‡§π‡•Ä
- **Note:** Code add ‡§ï‡•á‡§≤‡§æ ‡§™‡§£ UI ‡§Æ‡§ß‡•ç‡§Ø‡•á reflect ‡§π‡•ã‡§§ ‡§®‡§æ‡§π‡•Ä (cache issue?)

### Issue 3: Companies Page ‚Üí Sync Page Redirect
- **Problem:** Companies page click ‡§ï‡•á‡§≤‡•ç‡§Ø‡§æ‡§µ‡§∞ Sync page ‡§µ‡§∞ ‡§ú‡§æ‡§§‡•ã
- **Cause:** Same as Issue 1 - company_count = 0

### Issue 4: CSP Errors (Content Security Policy)
- **Problem:** Multiple CSP violations blocking:
  - Google Fonts (`fonts.googleapis.com`)
  - Service Worker fetch errors
- **Console Errors:**
  - `Connecting to '<URL>' violates Content Security Policy directive: "connect-src 'self'"`
  - `Fetch API cannot load https://fonts.googleapis.com/...`

### Issue 5: PWA Icon Error
- **Problem:** `icon-192.png` not found
- **Error:** `Download error or resource isn't a valid image`

### Issue 6: Modal.js Error
- **Problem:** `ReferenceError: Modal is not defined`
- **Location:** `dashboard.html:333`

---

## Root Cause Analysis

**Main Issue:** TallyInsight ‡§Æ‡§ß‡•ç‡§Ø‡•á company synced ‡§Ü‡§π‡•á ‡§™‡§£ TallyBridge database ‡§Æ‡§ß‡•ç‡§Ø‡•á company create ‡§ù‡§æ‡§≤‡•á‡§≤‡•Ä ‡§®‡§æ‡§π‡•Ä.

**Flow Problem:**
```
1. User syncs company in TallyInsight ‚úÖ
2. Webhook should create company in TallyBridge ‚ùå (Not happening)
3. Dashboard checks company_count = 0 ‚Üí Redirects to Sync ‚ùå
```

---

## Task List

### Priority 1: Fix Company Sync Webhook (CRITICAL)

| Task ID | Task Description | Status | Notes |
|---------|------------------|--------|-------|
| BF5-01 | Debug webhook - why company not created in TallyBridge | üî¥ | Main issue |
| BF5-02 | Verify /api/v1/tally/webhook/sync-complete endpoint | üî¥ | Check if called |
| BF5-03 | Check if company exists in TallyBridge DB | üî¥ | Manual check |

### Priority 2: Fix Redirect Logic

| Task ID | Task Description | Status | Notes |
|---------|------------------|--------|-------|
| BF5-04 | Dashboard should not redirect if synced companies exist | üî¥ | Logic fix |
| BF5-05 | Companies page same issue | üî¥ | Logic fix |

### Priority 3: Fix Sidebar Link

| Task ID | Task Description | Status | Notes |
|---------|------------------|--------|-------|
| BF5-06 | Verify Tally Sync link in dashboard.html | üî¥ | Check code |
| BF5-07 | Clear browser cache and test | üî¥ | Cache issue? |

### Priority 4: Fix CSP Errors

| Task ID | Task Description | Status | Notes |
|---------|------------------|--------|-------|
| BF5-08 | Update CSP headers in backend | üî¥ | Allow fonts.googleapis.com |
| BF5-09 | Fix Service Worker CSP | üî¥ | sw.js line 52 |

### Priority 5: Fix Other Errors

| Task ID | Task Description | Status | Notes |
|---------|------------------|--------|-------|
| BF5-10 | Fix PWA icon path | üî¥ | icon-192.png |
| BF5-11 | Fix Modal.js not defined | üî¥ | dashboard.html |

---

## Progress Summary

| Priority | Tasks | Completed |
|----------|-------|-----------|
| P1 - Webhook | 3 | 2 |
| P2 - Redirect | 2 | 1 |
| P3 - Sidebar | 2 | 2 |
| P4 - CSP | 2 | 1 |
| P5 - Other | 2 | 0 |
| **Total** | **11** | **6** |

---

## Fixes Applied:

### BF5-01: Webhook Fix ‚úÖ
- **File:** `app/routes/tally.py`
- **Issue:** Company model requires `email` field but webhook didn't provide it
- **Fix:** Generate default email from company name: `{safe_name}@tally.local`

### BF5-06 & BF5-07: Sidebar & Cache ‚úÖ
- **File:** `sw.js`
- **Fix:** Updated cache version to `appkit-v3` to force browser refresh
- Tally Sync link already exists in sidebar (line 146)

### BF5-09: Service Worker CSP ‚úÖ
- **File:** `sw.js`
- **Fix:** Skip external URLs in fetch handler to avoid CSP violations

---

## Next Steps:
1. Restart TallyBridge server
2. Clear browser cache (Ctrl+Shift+Delete)
3. Re-sync a company from Tally Sync page
4. Verify company appears in dashboard
